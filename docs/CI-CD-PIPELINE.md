# CI/CDパイプライン 包括的図解

## 📋 目次

1. [概要](#概要)
2. [パイプライン全体フロー図](#パイプライン全体フロー図)
3. [ワークフロー詳細](#ワークフロー詳細)
4. [技術スタック](#技術スタック)
5. [外部サービス連携](#外部サービス連携)

---

## 概要

**プロジェクト**: challecara
**アーキテクチャ**: Next.js 16 + Clean Architecture
**パッケージマネージャ**: pnpm v10.12.1
**Node.js**: v20
**デプロイ先**: Cloudflare Pages + Firebase

---

## パイプライン全体フロー図

```
┌──────────────────────────────────────────────────────────────────────┐
│                         プルリクエスト作成                              │
└────────────────────────────┬─────────────────────────────────────────┘
                             ↓
        ┌────────────────────┴────────────────────┐
        ↓                                         ↓
┌───────────────────┐                 ┌──────────────────────┐
│ PRタイトル検証     │                 │ PR変更内容ラベル付与  │
│ pr-name-check.yml │                 │ label-pr-changes.yml │
└────────┬──────────┘                 └──────────┬───────────┘
         │                                       │
         │  ✓ feat:, fix:, etc.                 │  ✓ frontend
         │  ✗ 不正な形式                         │  ✓ backend
         │                                       │  ✓ ci
         │                                       │  ✓ test
         └───────────────┬───────────────────────┘
                         ↓
┌──────────────────────────────────────────────────────────────────────┐
│                         メインCIパイプライン                            │
│                            ci.yml                                     │
└────────────────────────────┬─────────────────────────────────────────┘
                             ↓
        ┌────────────────────┼────────────────────┐
        ↓                    ↓                    ↓
┌───────────────┐   ┌────────────────┐   ┌──────────────────┐
│ Reminder Lint │   │ Lint & Type    │   │ Frontend Tests   │
│               │   │ Check          │   │                  │
│ CyberAgent    │   │                │   │ Vitest           │
│ Docker Image  │   │ • Biome        │   │ src/app/interface│
│               │   │ • TypeScript   │   │ src/lib          │
│ タイムアウト   │   │                │   │                  │
│ 5分           │   │ タイムアウト    │   │ タイムアウト      │
│               │   │ 10分           │   │ 10分             │
└───────┬───────┘   └────────┬───────┘   └────────┬─────────┘
        │                    │                    │
        └────────────────────┼────────────────────┘
                             ↓
                    ┌────────────────┐
                    │ Backend Tests  │
                    │                │
                    │ Vitest         │
                    │ src/app/domain │
                    │ src/app/infra  │
                    │ src/app/api    │
                    │                │
                    │ タイムアウト    │
                    │ 10分           │
                    └────────┬───────┘
                             ↓
                    ┌────────────────┐
                    │ Build          │
                    │                │
                    │ NODE_ENV=prod  │
                    │ pnpm build     │
                    │                │
                    │ 事前フック:     │
                    │ openapi:gen    │
                    │                │
                    │ タイムアウト    │
                    │ 10分           │
                    └────────┬───────┘
                             ↓
                    ┌────────────────┐
                    │  CI完了        │
                    └────────┬───────┘
                             ↓
        ┌────────────────────┴────────────────────┐
        ↓                                         ↓
┌───────────────────┐                 ┌──────────────────────┐
│ CI結果の自動       │                 │ Cloudflare Pages     │
│ ラベル付与         │                 │ プレビューデプロイ    │
│                   │                 │                      │
│ auto-label-       │                 │ cloudflare-pages-    │
│ ci-errors.yml     │                 │ preview.yml          │
│                   │                 │                      │
│ 成功時:            │                 │ • ビルド実行         │
│ • ラベル削除       │                 │ • Cloudflare適用     │
│                   │                 │ • Pages デプロイ     │
│ 失敗時:            │                 │ • PR コメント追加    │
│ • error:lint      │                 │                      │
│ • error:test-fe   │                 │ プレビューURL:       │
│ • error:test-be   │                 │ challecara.pages.dev │
│ • error:build     │                 │                      │
└───────────────────┘                 └──────────────────────┘
```

---

## ワークフロー詳細

### 1️⃣ PRタイトル検証 (pr-name-check.yml)

**トリガー**: PR作成・編集・同期・再オープン

```
┌─────────────────────────────────────────┐
│  PR タイトル形式チェック                 │
├─────────────────────────────────────────┤
│  許可されたプレフィックス:               │
│  • feat: - 新機能                       │
│  • fix: - バグ修正                      │
│  • docs: - ドキュメント                 │
│  • chore: - ビルド・ツール              │
│  • refactor: - リファクタリング         │
│  • test: - テスト追加・修正             │
│  • style: - コードスタイル              │
│  • perf: - パフォーマンス改善           │
│  • ci: - CI/CD変更                     │
│  • prod: - プロダクションリリース       │
│  • hotfix: - 緊急バグ修正               │
├─────────────────────────────────────────┤
│  正規表現パターン:                       │
│  ^(feat|fix|...):\s.+$                  │
├─────────────────────────────────────────┤
│  ✓ 正しい例: "feat: ユーザー認証機能"   │
│  ✗ 間違い例: "Add feature"              │
│  ✗ 間違い例: "feat(scope): feature"     │
└─────────────────────────────────────────┘
```

### 2️⃣ PR変更内容ラベル (label-pr-changes.yml)

**トリガー**: PR作成・同期・再オープン

```
┌─────────────────────────────────────────────────────────────┐
│  変更ファイル検出 → 自動ラベル付与                           │
├─────────────────────────────────────────────────────────────┤
│  frontend (青 #1d76db)                                      │
│  • src/app/interface/                                       │
│  • src/lib/                                                 │
│  • public/                                                  │
│  • next.config.*                                            │
│  • tailwind.config.*                                        │
│  • postcss.config.*                                         │
├─────────────────────────────────────────────────────────────┤
│  backend (赤 #d73a4a)                                       │
│  • src/app/domain/                                          │
│  • src/app/infrastructure/                                  │
│  • src/app/api/                                             │
│  • src/app/config/                                          │
│  • firestore.rules                                          │
│  • firestore.indexes.json                                   │
├─────────────────────────────────────────────────────────────┤
│  ci (黄 #fbca04)                                            │
│  • .github/workflows/                                       │
│  • Makefile                                                 │
│  • scripts/                                                 │
├─────────────────────────────────────────────────────────────┤
│  test (黄 #fbbf24)                                          │
│  • src/test/                                                │
│  • *.test.ts                                                │
│  • *.test.tsx                                               │
│  • vitest.config.*                                          │
│  • vitest.setup.*                                           │
└─────────────────────────────────────────────────────────────┘
```

### 3️⃣ メインCIパイプライン (ci.yml)

**トリガー**:
- push to `main`, `develop`
- Pull Request (全ブランチ)

```
┌──────────────────────────────────────────────────────────────┐
│  Job 1: Reminder Lint                                        │
│  タイムアウト: 5分 | OS: ubuntu-latest                        │
├──────────────────────────────────────────────────────────────┤
│  1. Dockerイメージで実行                                      │
│     ghcr.io/cyberagent/reminder-lint:latest                  │
│  2. コード内のリマインダー・TODOチェック                      │
└──────────────────────────────────────────────────────────────┘
                            ↓
┌──────────────────────────────────────────────────────────────┐
│  Job 2: Lint and Type Check                                  │
│  タイムアウト: 10分 | OS: ubuntu-latest                       │
├──────────────────────────────────────────────────────────────┤
│  1. pnpm セットアップ (Node.js 20)                           │
│  2. 依存関係インストール (frozen-lockfile)                    │
│  3. Biome フォーマットチェック                                │
│     pnpm format:check                                        │
│  4. TypeScript型チェック                                      │
│     pnpm exec tsc --noEmit                                   │
│                                                              │
│  エラー時: 詳細メッセージ (日本語)                            │
└──────────────────────────────────────────────────────────────┘
                            ↓
┌──────────────────────────────────────────────────────────────┐
│  Job 3: Frontend Unit Tests                                  │
│  タイムアウト: 10分 | OS: ubuntu-latest                       │
├──────────────────────────────────────────────────────────────┤
│  1. pnpm セットアップ (Node.js 20)                           │
│  2. 依存関係インストール                                      │
│  3. フロントエンドテスト実行                                  │
│     pnpm vitest run src/app/interface src/lib                │
│                                                              │
│  対象:                                                        │
│  • UIコンポーネント                                           │
│  • 画面                                                       │
│  • 状態管理                                                   │
└──────────────────────────────────────────────────────────────┘
                            ↓
┌──────────────────────────────────────────────────────────────┐
│  Job 4: Backend Unit Tests                                   │
│  タイムアウト: 10分 | OS: ubuntu-latest                       │
├──────────────────────────────────────────────────────────────┤
│  1. pnpm セットアップ (Node.js 20)                           │
│  2. 依存関係インストール                                      │
│  3. バックエンドテスト実行                                    │
│     pnpm vitest run src/app/domain \                         │
│                     src/app/infrastructure \                 │
│                     src/app/api                              │
│                                                              │
│  対象:                                                        │
│  • ドメイン層                                                 │
│  • インフラストラクチャ層                                     │
│  • APIレイヤー                                                │
└──────────────────────────────────────────────────────────────┘
                            ↓
┌──────────────────────────────────────────────────────────────┐
│  Job 5: Build                                                │
│  タイムアウト: 10分 | OS: ubuntu-latest                       │
│  依存: lint, test-frontend, test-backend                     │
├──────────────────────────────────────────────────────────────┤
│  1. pnpm セットアップ (Node.js 20)                           │
│  2. 依存関係インストール                                      │
│  3. ビルド前フック: OpenAPI生成                               │
│     (package.json: prebuild スクリプト)                       │
│  4. プロダクションビルド                                      │
│     NODE_ENV=production pnpm build                           │
│                                                              │
│  出力: Next.js プロダクションアーティファクト                 │
└──────────────────────────────────────────────────────────────┘
```

### 4️⃣ CI結果自動ラベル (auto-label-ci-errors.yml)

**トリガー**: CI ワークフロー完了時 (PR対象のみ)

**権限**: contents:read, pull-requests:write, actions:read

```
┌──────────────────────────────────────────────────────────────┐
│  CI ジョブ結果取得                                            │
├──────────────────────────────────────────────────────────────┤
│  • Lint and Type Check → 状態確認                            │
│  • Frontend Unit Tests → 状態確認                            │
│  • Backend Unit Tests  → 状態確認                            │
│  • Build               → 状態確認                            │
└──────────────┬───────────────────────────────────────────────┘
               ↓
┌──────────────────────────────────────────────────────────────┐
│  エラーラベル作成 (存在しない場合)                            │
├──────────────────────────────────────────────────────────────┤
│  • error:lint     (赤 #d73a4a) - Lint/型エラー               │
│  • error:test-fe  (赤 #d73a4a) - FEテスト失敗                │
│  • error:test-be  (赤 #d73a4a) - BEテスト失敗                │
│  • error:build    (赤 #d73a4a) - ビルド失敗                  │
└──────────────┬───────────────────────────────────────────────┘
               ↓
┌──────────────────────────────────────────────────────────────┐
│  PRラベル更新                                                 │
├──────────────────────────────────────────────────────────────┤
│  ジョブ失敗 (status: "failure")   → ラベル追加               │
│  ジョブ成功 (status: "success")   → ラベル削除               │
├──────────────────────────────────────────────────────────────┤
│  サマリー: 全ジョブ状態を表示                                │
└──────────────────────────────────────────────────────────────┘
```

### 5️⃣ Cloudflare Pages プレビュー (cloudflare-pages-preview.yml)

**トリガー**: PR作成・同期・再オープン

**権限**: contents:read, pull-requests:write, deployments:write

```
┌──────────────────────────────────────────────────────────────┐
│  Step 1: コードチェックアウト                                 │
└──────────────┬───────────────────────────────────────────────┘
               ↓
┌──────────────────────────────────────────────────────────────┐
│  Step 2: pnpm セットアップ (Node.js 20 + キャッシュ)         │
└──────────────┬───────────────────────────────────────────────┘
               ↓
┌──────────────────────────────────────────────────────────────┐
│  Step 3: 依存関係インストール (frozen-lockfile)              │
└──────────────┬───────────────────────────────────────────────┘
               ↓
┌──────────────────────────────────────────────────────────────┐
│  Step 4: Cloudflare アダプタでビルド                         │
├──────────────────────────────────────────────────────────────┤
│  コマンド:                                                    │
│  pnpm run build &&                                           │
│  npx @cloudflare/next-on-pages@latest                        │
│                                                              │
│  環境変数 (GitHub Secrets):                                  │
│  • NEXT_PUBLIC_FIREBASE_API_KEY                              │
│  • NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN                          │
│  • NEXT_PUBLIC_FIREBASE_PROJECT_ID                           │
│  • NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET                       │
│  • NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID                  │
│  • NEXT_PUBLIC_FIREBASE_APP_ID                               │
│                                                              │
│  出力: .vercel/output/static                                 │
└──────────────┬───────────────────────────────────────────────┘
               ↓
┌──────────────────────────────────────────────────────────────┐
│  Step 5: Cloudflare Pages デプロイ                          │
├──────────────────────────────────────────────────────────────┤
│  アクション: cloudflare/wrangler-action@v3                   │
│                                                              │
│  シークレット:                                                │
│  • CLOUDFLARE_API_TOKEN                                      │
│  • CLOUDFLARE_ACCOUNT_ID                                     │
│                                                              │
│  コマンド:                                                    │
│  pages deploy .vercel/output/static \                        │
│    --project-name=challecara \                               │
│    --branch=${{ github.head_ref }}                           │
│                                                              │
│  ブランチ別デプロイで整理                                     │
└──────────────┬───────────────────────────────────────────────┘
               ↓
┌──────────────────────────────────────────────────────────────┐
│  Step 6: PRにコメント投稿                                     │
├──────────────────────────────────────────────────────────────┤
│  内容:                                                        │
│  • プレビューURL (https://challecara.pages.dev)              │
│  • ブランチ名                                                 │
│  • コミットSHA                                                │
│                                                              │
│  更新時: 既存のボットコメントを自動更新                       │
└──────────────────────────────────────────────────────────────┘
```

---

## 技術スタック

### コード品質管理

```
┌─────────────────────────────────────────────────────────────┐
│  Biome v1.9.4 (フォーマッター & リンター)                    │
├─────────────────────────────────────────────────────────────┤
│  フォーマット設定:                                           │
│  • インデント: 2スペース                                     │
│  • 行末: LF                                                  │
│  • 行幅: 100文字                                             │
│  • 末尾カンマ: ES5スタイル                                   │
│  • クォート: ダブルクォート                                  │
├─────────────────────────────────────────────────────────────┤
│  リンタールール:                                             │
│  • 推奨ベースルール有効                                      │
│  • noExplicitAny: warn                                       │
│  • noArrayIndexKey: warn                                     │
│  • useConst: error                                           │
│  • noUnusedVariables: warn                                   │
│  • useExhaustiveDependencies: warn                           │
├─────────────────────────────────────────────────────────────┤
│  コマンド:                                                   │
│  • pnpm format       - 自動修正                              │
│  • pnpm format:check - チェックのみ                          │
│  • pnpm biome:check  - 全チェック                            │
│  • pnpm biome:fix    - 全自動修正                            │
└─────────────────────────────────────────────────────────────┘
```

### テストフレームワーク

```
┌─────────────────────────────────────────────────────────────┐
│  Vitest v2.1.8                                              │
├─────────────────────────────────────────────────────────────┤
│  環境: jsdom (ブラウザシミュレーション)                      │
│  カバレッジ: v8プロバイダー                                  │
│  レポーター: text, json, html                                │
├─────────────────────────────────────────────────────────────┤
│  テストライブラリ:                                           │
│  • @testing-library/react     - コンポーネントテスト         │
│  • @testing-library/jest-dom  - DOMマッチャー                │
│  • @vitest/ui                 - ビジュアルテストランナー     │
│  • @vitest/coverage-v8        - カバレッジレポート           │
├─────────────────────────────────────────────────────────────┤
│  テスト分類:                                                 │
│  Frontend: src/app/interface, src/lib                       │
│  Backend:  src/app/domain, src/app/infrastructure,          │
│            src/app/api                                       │
├─────────────────────────────────────────────────────────────┤
│  コマンド:                                                   │
│  • pnpm test           - 全テスト実行                        │
│  • pnpm test:watch    - ウォッチモード                       │
│  • pnpm test:ui       - ビジュアルUI                         │
│  • pnpm test:coverage - カバレッジレポート                   │
└─────────────────────────────────────────────────────────────┘
```

### TypeScript設定

```
┌─────────────────────────────────────────────────────────────┐
│  TypeScript                                                 │
├─────────────────────────────────────────────────────────────┤
│  • ターゲット: ES2017                                        │
│  • モジュール: ESNext (bundler resolution)                   │
│  • Strictモード: 有効                                        │
│  • noEmit: true (型チェックのみ)                             │
│  • isolatedModules: true                                     │
│  • incremental: true (高速リビルド)                          │
├─────────────────────────────────────────────────────────────┤
│  パスエイリアス:                                             │
│  @/* → ./src/*                                              │
└─────────────────────────────────────────────────────────────┘
```

---

## 外部サービス連携

```
┌────────────────────────────────────────────────────────────────┐
│                     Cloudflare Pages                           │
├────────────────────────────────────────────────────────────────┤
│  プロジェクト: challecara                                       │
│  戦略: ブランチベースプレビューデプロイ                         │
│  認証: API Token + Account ID (Secrets)                        │
│  出力: ライブプレビューURL (PRコメント)                         │
└────────────────────────────────────────────────────────────────┘
                              ↕
┌────────────────────────────────────────────────────────────────┐
│                          Firebase                              │
├────────────────────────────────────────────────────────────────┤
│  • Authentication (認証設定)                                    │
│  • Firestore (データベース)                                     │
│  • Security Rules (firestore.rules)                            │
│  • Indexes (firestore.indexes.json)                            │
│                                                                │
│  認証情報: GitHub Secrets経由                                   │
└────────────────────────────────────────────────────────────────┘
                              ↕
┌────────────────────────────────────────────────────────────────┐
│                         GitHub                                 │
├────────────────────────────────────────────────────────────────┤
│  • Webhookトリガー (全ワークフロー)                             │
│  • API Token (PRラベル・コメント)                               │
│  • CODEOWNERS (自動レビューリクエスト)                          │
│    - @dokkiitech                                               │
│    - @0-s0-g0                                                  │
└────────────────────────────────────────────────────────────────┘
```

---

## ビルド＆デプロイフロー

```
┌─────────────────────────────────────────────────────────────┐
│  開発者: コード変更 & プッシュ                               │
└───────────────────────┬─────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────────┐
│  Pre-Build Hook                                             │
│  • OpenAPI仕様生成 (scripts/generate-openapi.ts)            │
└───────────────────────┬─────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────────┐
│  Next.js Compilation                                        │
│  • React 19コンポーネント最適化                              │
│  • Tailwind CSS v4 処理                                     │
│  • パスエイリアス解決                                        │
└───────────────────────┬─────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────────┐
│  Cloudflare Adapter                                         │
│  • @cloudflare/next-on-pages                                │
│  • Edgeランタイム互換性変換                                  │
│  • 出力: .vercel/output/static                              │
└───────────────────────┬─────────────────────────────────────┘
                        ↓
┌─────────────────────────────────────────────────────────────┐
│  Cloudflare Pages Deployment                                │
│  • ブランチ別デプロイ                                        │
│  • グローバルCDN配信                                         │
│  • プレビューURL生成                                         │
└─────────────────────────────────────────────────────────────┘
```

---

## セキュリティ & ベストプラクティス

### シークレット管理

```
GitHub Secrets (暗号化保存)
├── CLOUDFLARE_API_TOKEN
├── CLOUDFLARE_ACCOUNT_ID
├── NEXT_PUBLIC_FIREBASE_API_KEY
├── NEXT_PUBLIC_FIREBASE_AUTH_DOMAIN
├── NEXT_PUBLIC_FIREBASE_PROJECT_ID
├── NEXT_PUBLIC_FIREBASE_STORAGE_BUCKET
├── NEXT_PUBLIC_FIREBASE_MESSAGING_SENDER_ID
└── NEXT_PUBLIC_FIREBASE_APP_ID

❌ リポジトリにコミット禁止
✅ GitHub Actionsでのみアクセス
```

### 品質ゲート

```
┌─────────────────────────────────────────────────────────────┐
│  必須チェックポイント (順序)                                 │
├─────────────────────────────────────────────────────────────┤
│  1️⃣ Reminder Lint       → TODO/リマインダー管理             │
│  2️⃣ Lint & Type Check   → コード品質                        │
│  3️⃣ Frontend Tests      → UI/コンポーネント検証             │
│  4️⃣ Backend Tests       → ビジネスロジック検証              │
│  5️⃣ Build               → プロダクションビルド成功          │
├─────────────────────────────────────────────────────────────┤
│  ⚠️ いずれか失敗 → デプロイ不可                              │
│  ✅ 全て成功 → Cloudflare Pagesへデプロイ                    │
└─────────────────────────────────────────────────────────────┘
```

### エラーハンドリング

```
┌─────────────────────────────────────────────────────────────┐
│  エラー検出システム                                          │
├─────────────────────────────────────────────────────────────┤
│  • 詳細エラーメッセージ (日本語)                             │
│  • 早期失敗 (連鎖エラー防止)                                 │
│  • 自動PRラベル付与 (素早い問題特定)                         │
│  • デプロイ前チェック (品質保証)                             │
└─────────────────────────────────────────────────────────────┘
```

---

## ローカル開発コマンド (Makefile)

```bash
# セットアップ
make install          # pnpm install

# 開発
make dev              # Next.js 開発サーバー
make build            # プロダクションビルド
make start            # プロダクションサーバー

# テスト
make test             # 全テスト実行
make test-frontend    # フロントエンドのみ
make test-backend     # バックエンドのみ
make test-watch       # ウォッチモード
make test-ui          # Vitest UI
make test-coverage    # カバレッジレポート

# コード品質
make lint             # ESLintチェック
make format           # Biome自動修正
make format-check     # フォーマットチェックのみ
make biome-check      # Biome全チェック
make biome-fix        # Biome全自動修正

# その他
make openapi          # OpenAPI仕様生成
make ci               # ローカルで全CIチェック
make clean            # アーティファクト削除
```

---

## CI/CD成功の流れ

```
開発者プッシュ
    ↓
PR作成
    ↓
┌──────────────────────┐
│ PRタイトル検証       │ ✅ 通過
└──────────────────────┘
    ↓
┌──────────────────────┐
│ 変更内容ラベル付与   │ 🏷️  frontend, backend
└──────────────────────┘
    ↓
┌──────────────────────┐
│ Reminder Lint        │ ✅ 通過
└──────────────────────┘
    ↓
┌──────────────────────┐
│ Lint & Type Check    │ ✅ 通過
└──────────────────────┘
    ↓
┌──────────────────────┐
│ Frontend Tests       │ ✅ 通過 (15 tests)
└──────────────────────┘
    ↓
┌──────────────────────┐
│ Backend Tests        │ ✅ 通過 (23 tests)
└──────────────────────┘
    ↓
┌──────────────────────┐
│ Build                │ ✅ 成功
└──────────────────────┘
    ↓
┌──────────────────────┐
│ エラーラベル削除     │ 🧹 クリーンアップ
└──────────────────────┘
    ↓
┌──────────────────────┐
│ Cloudflare Deploy    │ 🚀 デプロイ完了
└──────────────────────┘
    ↓
┌──────────────────────┐
│ プレビューURL投稿    │ 💬 PRコメント
└──────────────────────┘
    ↓
レビュー準備完了 ✨
```

---

## まとめ

このCI/CDパイプラインは、以下を実現します:

✅ **自動品質チェック**: Lint、型チェック、テストの自動実行
✅ **迅速なフィードバック**: PRラベルで問題箇所を即座に可視化
✅ **安全なデプロイ**: 全チェック通過後のみデプロイ可能
✅ **プレビュー環境**: 各PRに専用プレビューURL
✅ **開発効率化**: 自動化により手動作業を削減
✅ **コード品質維持**: Strictモード + リンター + テストで高品質保証

**パイプライン実行時間**: 約10-15分 (並列実行により最適化)
