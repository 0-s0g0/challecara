name: Auto Label CI Errors

on:
  workflow_run:
    workflows: ["CI"]
    types:
      - completed

jobs:
  label-ci-errors:
    name: Label CI Errors
    runs-on: ubuntu-latest
    # PRã«å¯¾ã—ã¦ã®ã¿å®Ÿè¡Œ
    if: github.event.workflow_run.event == 'pull_request'
    permissions:
      contents: read
      pull-requests: write
      actions: read

    steps:
      - name: Get PR number
        id: pr
        run: |
          # PRã®ç•ªå·ã‚’å–å¾—
          PR_NUMBER=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}" \
            --jq '.pull_requests[0].number')

          echo "PRç•ªå·: $PR_NUMBER"
          echo "pr_number=$PR_NUMBER" >> $GITHUB_OUTPUT

          if [ -z "$PR_NUMBER" ] || [ "$PR_NUMBER" = "null" ]; then
            echo "âš ï¸  ã“ã®ãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼å®Ÿè¡Œã«PRãŒé–¢é€£ä»˜ã‘ã‚‰ã‚Œã¦ã„ã¾ã›ã‚“"
            exit 0
          fi
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Get CI job results
        id: jobs
        if: steps.pr.outputs.pr_number != ''
        run: |
          # CIãƒ¯ãƒ¼ã‚¯ãƒ•ãƒ­ãƒ¼ã®å„ã‚¸ãƒ§ãƒ–ã®çµæœã‚’å–å¾—
          JOBS_JSON=$(gh api \
            -H "Accept: application/vnd.github+json" \
            "/repos/${{ github.repository }}/actions/runs/${{ github.event.workflow_run.id }}/jobs")

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š CIã‚¸ãƒ§ãƒ–ã®çµæœ"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""

          # å„ã‚¸ãƒ§ãƒ–ã®çµæœã‚’ç¢ºèª
          LINT_STATUS=$(echo "$JOBS_JSON" | jq -r '.jobs[] | select(.name == "Lint and Type Check") | .conclusion')
          TEST_FE_STATUS=$(echo "$JOBS_JSON" | jq -r '.jobs[] | select(.name == "Frontend Unit Tests") | .conclusion')
          TEST_BE_STATUS=$(echo "$JOBS_JSON" | jq -r '.jobs[] | select(.name == "Backend Unit Tests") | .conclusion')
          BUILD_STATUS=$(echo "$JOBS_JSON" | jq -r '.jobs[] | select(.name == "Build") | .conclusion')

          echo "Lint and Type Check: $LINT_STATUS"
          echo "Frontend Unit Tests: $TEST_FE_STATUS"
          echo "Backend Unit Tests:  $TEST_BE_STATUS"
          echo "Build:               $BUILD_STATUS"
          echo ""

          # çµæœã‚’ç’°å¢ƒå¤‰æ•°ã«ä¿å­˜
          echo "lint_status=$LINT_STATUS" >> $GITHUB_OUTPUT
          echo "test_fe_status=$TEST_FE_STATUS" >> $GITHUB_OUTPUT
          echo "test_be_status=$TEST_BE_STATUS" >> $GITHUB_OUTPUT
          echo "build_status=$BUILD_STATUS" >> $GITHUB_OUTPUT
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Create error labels if not exist
        if: steps.pr.outputs.pr_number != ''
        run: |
          echo "ğŸ·ï¸  ã‚¨ãƒ©ãƒ¼ãƒ©ãƒ™ãƒ«ã‚’æº–å‚™ä¸­..."
          echo ""

          # ã‚¨ãƒ©ãƒ¼ãƒ©ãƒ™ãƒ«ã‚’ä½œæˆï¼ˆèµ¤è‰²ï¼‰
          gh label create "error:lint" \
            --repo "${{ github.repository }}" \
            --description "Lintã¾ãŸã¯å‹ãƒã‚§ãƒƒã‚¯ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ" \
            --color "d73a4a" \
            --force 2>/dev/null || echo "âœ“ error:lint ãƒ©ãƒ™ãƒ«ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™"

          gh label create "error:test-fe" \
            --repo "${{ github.repository }}" \
            --description "ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ" \
            --color "d73a4a" \
            --force 2>/dev/null || echo "âœ“ error:test-fe ãƒ©ãƒ™ãƒ«ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™"

          gh label create "error:test-be" \
            --repo "${{ github.repository }}" \
            --description "ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ" \
            --color "d73a4a" \
            --force 2>/dev/null || echo "âœ“ error:test-be ãƒ©ãƒ™ãƒ«ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™"

          gh label create "error:build" \
            --repo "${{ github.repository }}" \
            --description "ãƒ“ãƒ«ãƒ‰ã§ã‚¨ãƒ©ãƒ¼ãŒç™ºç”Ÿ" \
            --color "d73a4a" \
            --force 2>/dev/null || echo "âœ“ error:build ãƒ©ãƒ™ãƒ«ã¯æ—¢ã«å­˜åœ¨ã—ã¾ã™"

          echo ""
          echo "âœ… ã‚¨ãƒ©ãƒ¼ãƒ©ãƒ™ãƒ«ã®æº–å‚™ãŒå®Œäº†ã—ã¾ã—ãŸ"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Update Lint labels
        if: steps.pr.outputs.pr_number != '' && steps.jobs.outputs.lint_status != ''
        run: |
          PR_NUMBER="${{ steps.pr.outputs.pr_number }}"
          STATUS="${{ steps.jobs.outputs.lint_status }}"

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ” Lint ãƒ©ãƒ™ãƒ«ã®æ›´æ–°"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          if [ "$STATUS" = "failure" ]; then
            echo "âŒ Lintã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            echo "   'error:lint' ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ ã—ã¾ã™"
            gh pr edit "$PR_NUMBER" --add-label "error:lint"
            echo "âœ… ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ ã—ã¾ã—ãŸ"
          elif [ "$STATUS" = "success" ]; then
            echo "âœ… Lintãƒã‚§ãƒƒã‚¯ãŒæˆåŠŸã—ã¾ã—ãŸ"
            echo "   'error:lint' ãƒ©ãƒ™ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰"
            gh pr edit "$PR_NUMBER" --remove-label "error:lint" 2>/dev/null || echo "   ï¼ˆãƒ©ãƒ™ãƒ«ã¯ä»˜ã„ã¦ã„ã¾ã›ã‚“ã§ã—ãŸï¼‰"
          else
            echo "âš ï¸  Lint: ä¸æ˜ãªçŠ¶æ…‹ ($STATUS)"
          fi
          echo ""
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Update Frontend Test labels
        if: steps.pr.outputs.pr_number != '' && steps.jobs.outputs.test_fe_status != ''
        run: |
          PR_NUMBER="${{ steps.pr.outputs.pr_number }}"
          STATUS="${{ steps.jobs.outputs.test_fe_status }}"

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ§ª Frontend Test ãƒ©ãƒ™ãƒ«ã®æ›´æ–°"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          if [ "$STATUS" = "failure" ]; then
            echo "âŒ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            echo "   'error:test-fe' ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ ã—ã¾ã™"
            gh pr edit "$PR_NUMBER" --add-label "error:test-fe"
            echo "âœ… ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ ã—ã¾ã—ãŸ"
          elif [ "$STATUS" = "success" ]; then
            echo "âœ… ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸ"
            echo "   'error:test-fe' ãƒ©ãƒ™ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰"
            gh pr edit "$PR_NUMBER" --remove-label "error:test-fe" 2>/dev/null || echo "   ï¼ˆãƒ©ãƒ™ãƒ«ã¯ä»˜ã„ã¦ã„ã¾ã›ã‚“ã§ã—ãŸï¼‰"
          else
            echo "âš ï¸  Frontend Test: ä¸æ˜ãªçŠ¶æ…‹ ($STATUS)"
          fi
          echo ""
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Update Backend Test labels
        if: steps.pr.outputs.pr_number != '' && steps.jobs.outputs.test_be_status != ''
        run: |
          PR_NUMBER="${{ steps.pr.outputs.pr_number }}"
          STATUS="${{ steps.jobs.outputs.test_be_status }}"

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ§ª Backend Test ãƒ©ãƒ™ãƒ«ã®æ›´æ–°"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          if [ "$STATUS" = "failure" ]; then
            echo "âŒ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            echo "   'error:test-be' ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ ã—ã¾ã™"
            gh pr edit "$PR_NUMBER" --add-label "error:test-be"
            echo "âœ… ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ ã—ã¾ã—ãŸ"
          elif [ "$STATUS" = "success" ]; then
            echo "âœ… ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ†ã‚¹ãƒˆãŒæˆåŠŸã—ã¾ã—ãŸ"
            echo "   'error:test-be' ãƒ©ãƒ™ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰"
            gh pr edit "$PR_NUMBER" --remove-label "error:test-be" 2>/dev/null || echo "   ï¼ˆãƒ©ãƒ™ãƒ«ã¯ä»˜ã„ã¦ã„ã¾ã›ã‚“ã§ã—ãŸï¼‰"
          else
            echo "âš ï¸  Backend Test: ä¸æ˜ãªçŠ¶æ…‹ ($STATUS)"
          fi
          echo ""
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Update Build labels
        if: steps.pr.outputs.pr_number != '' && steps.jobs.outputs.build_status != ''
        run: |
          PR_NUMBER="${{ steps.pr.outputs.pr_number }}"
          STATUS="${{ steps.jobs.outputs.build_status }}"

          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ”¨ Build ãƒ©ãƒ™ãƒ«ã®æ›´æ–°"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"

          if [ "$STATUS" = "failure" ]; then
            echo "âŒ ãƒ“ãƒ«ãƒ‰ã‚¨ãƒ©ãƒ¼ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            echo "   'error:build' ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ ã—ã¾ã™"
            gh pr edit "$PR_NUMBER" --add-label "error:build"
            echo "âœ… ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ ã—ã¾ã—ãŸ"
          elif [ "$STATUS" = "success" ]; then
            echo "âœ… ãƒ“ãƒ«ãƒ‰ãŒæˆåŠŸã—ã¾ã—ãŸ"
            echo "   'error:build' ãƒ©ãƒ™ãƒ«ã‚’å‰Šé™¤ã—ã¾ã™ï¼ˆå­˜åœ¨ã™ã‚‹å ´åˆï¼‰"
            gh pr edit "$PR_NUMBER" --remove-label "error:build" 2>/dev/null || echo "   ï¼ˆãƒ©ãƒ™ãƒ«ã¯ä»˜ã„ã¦ã„ã¾ã›ã‚“ã§ã—ãŸï¼‰"
          else
            echo "âš ï¸  Build: ä¸æ˜ãªçŠ¶æ…‹ ($STATUS)"
          fi
          echo ""
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Summary
        if: steps.pr.outputs.pr_number != ''
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š CI ã‚¨ãƒ©ãƒ¼ãƒ©ãƒ™ãƒ«æ›´æ–°å®Œäº†"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "PR #${{ steps.pr.outputs.pr_number }} ã®ãƒ©ãƒ™ãƒ«ã‚’æ›´æ–°ã—ã¾ã—ãŸ"
          echo ""
          echo "ã‚¸ãƒ§ãƒ–ã®çµæœ:"
          echo "  Lint:         ${{ steps.jobs.outputs.lint_status }}"
          echo "  Frontend Test: ${{ steps.jobs.outputs.test_fe_status }}"
          echo "  Backend Test:  ${{ steps.jobs.outputs.test_be_status }}"
          echo "  Build:        ${{ steps.jobs.outputs.build_status }}"
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
