name: Label PR Changes

on:
  pull_request:
    types: [opened, synchronize, reopened]

jobs:
  label-changes:
    name: Detect and Label FE/BE Changes
    runs-on: ubuntu-latest
    permissions:
      contents: read
      pull-requests: write

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get changed files
        id: changed-files
        run: |
          # ãƒ™ãƒ¼ã‚¹ãƒ–ãƒ©ãƒ³ãƒã¨ã®å·®åˆ†ã‚’å–å¾—
          git fetch origin ${{ github.event.pull_request.base.ref }}
          CHANGED_FILES=$(git diff --name-only origin/${{ github.event.pull_request.base.ref }}...HEAD)

          echo "å¤‰æ›´ã•ã‚ŒãŸãƒ•ã‚¡ã‚¤ãƒ«:"
          echo "$CHANGED_FILES"
          echo ""

          # å¤‰æ›´ãƒ•ã‚¡ã‚¤ãƒ«ã‚’ç’°å¢ƒå¤‰æ•°ã«ä¿å­˜
          echo "CHANGED_FILES<<EOF" >> $GITHUB_ENV
          echo "$CHANGED_FILES" >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

      - name: Detect Frontend changes
        id: detect-fe
        run: |
          FE_CHANGED=false

          # ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰é–¢é€£ã®ãƒ‘ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³
          FE_PATTERNS=(
            "^src/app/interface/"
            "^src/lib/"
            "^public/"
            "^next\.config\."
            "^tailwind\.config\."
            "^postcss\.config\."
            "^vitest\.config\."
            "^vitest\.setup\."
          )

          echo "ğŸ” ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰å¤‰æ›´ã‚’æ¤œå‡ºä¸­..."
          echo ""

          while IFS= read -r file; do
            for pattern in "${FE_PATTERNS[@]}"; do
              if echo "$file" | grep -E "$pattern" > /dev/null; then
                echo "âœ… FE: $file"
                FE_CHANGED=true
              fi
            done
          done <<< "$CHANGED_FILES"

          echo ""
          if [ "$FE_CHANGED" = true ]; then
            echo "ğŸ“¦ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®å¤‰æ›´ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            echo "fe_changed=true" >> $GITHUB_OUTPUT
          else
            echo "ğŸ“¦ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ã®å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“"
            echo "fe_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Detect Backend changes
        id: detect-be
        run: |
          BE_CHANGED=false

          # ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰é–¢é€£ã®ãƒ‘ã‚¹ãƒ‘ã‚¿ãƒ¼ãƒ³
          BE_PATTERNS=(
            "^src/app/domain/"
            "^src/app/infrastructure/"
            "^src/app/api/"
            "^src/app/config/"
            "^firestore\.rules"
            "^firestore\.indexes\.json"
          )

          echo "ğŸ” ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰å¤‰æ›´ã‚’æ¤œå‡ºä¸­..."
          echo ""

          while IFS= read -r file; do
            for pattern in "${BE_PATTERNS[@]}"; do
              if echo "$file" | grep -E "$pattern" > /dev/null; then
                echo "âœ… BE: $file"
                BE_CHANGED=true
              fi
            done
          done <<< "$CHANGED_FILES"

          echo ""
          if [ "$BE_CHANGED" = true ]; then
            echo "ğŸ”§ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®å¤‰æ›´ãŒæ¤œå‡ºã•ã‚Œã¾ã—ãŸ"
            echo "be_changed=true" >> $GITHUB_OUTPUT
          else
            echo "ğŸ”§ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ã®å¤‰æ›´ã¯ã‚ã‚Šã¾ã›ã‚“"
            echo "be_changed=false" >> $GITHUB_OUTPUT
          fi

      - name: Add Frontend label
        if: steps.detect-fe.outputs.fe_changed == 'true'
        run: |
          echo "ğŸ·ï¸ ãƒ•ãƒ­ãƒ³ãƒˆã‚¨ãƒ³ãƒ‰ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ ä¸­..."
          gh pr edit ${{ github.event.pull_request.number }} --add-label "frontend"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Add Backend label
        if: steps.detect-be.outputs.be_changed == 'true'
        run: |
          echo "ğŸ·ï¸ ãƒãƒƒã‚¯ã‚¨ãƒ³ãƒ‰ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ ä¸­..."
          gh pr edit ${{ github.event.pull_request.number }} --add-label "backend"
        env:
          GH_TOKEN: ${{ github.token }}

      - name: Summary
        run: |
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo "ğŸ“Š å¤‰æ›´æ¤œçŸ¥çµæœ"
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
          echo ""
          echo "Frontend: ${{ steps.detect-fe.outputs.fe_changed }}"
          echo "Backend:  ${{ steps.detect-be.outputs.be_changed }}"
          echo ""

          if [ "${{ steps.detect-fe.outputs.fe_changed }}" = "true" ]; then
            echo "âœ… 'frontend' ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ ã—ã¾ã—ãŸ"
          fi

          if [ "${{ steps.detect-be.outputs.be_changed }}" = "true" ]; then
            echo "âœ… 'backend' ãƒ©ãƒ™ãƒ«ã‚’è¿½åŠ ã—ã¾ã—ãŸ"
          fi

          if [ "${{ steps.detect-fe.outputs.fe_changed }}" = "false" ] && [ "${{ steps.detect-be.outputs.be_changed }}" = "false" ]; then
            echo "â„¹ï¸  FE/BEã«é–¢é€£ã™ã‚‹å¤‰æ›´ã¯æ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ"
            echo "   ï¼ˆè¨­å®šãƒ•ã‚¡ã‚¤ãƒ«ã€ãƒ‰ã‚­ãƒ¥ãƒ¡ãƒ³ãƒˆã€ãƒ†ã‚¹ãƒˆãªã©ã®å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ï¼‰"
          fi
          echo ""
          echo "â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”"
